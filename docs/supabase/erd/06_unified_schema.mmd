%% Unified Schema ERD
%% Updated: 2026-01-16 (manual_players, chip_snapshots 삭제됨)

erDiagram
    %% GFX Schema
    gfx_sessions ||--o{ gfx_hands : contains
    gfx_hands ||--o{ gfx_hand_players : has
    gfx_hands ||--o{ gfx_events : has
    gfx_players ||--o{ gfx_hand_players : plays

    %% WSOP Schema
    wsop_events ||--o{ wsop_event_players : has
    wsop_events ||--o{ wsop_chip_counts : tracks
    wsop_players ||--o{ wsop_event_players : participates
    wsop_players ||--o{ wsop_chip_counts : has

    %% Override Schema (manual_players 삭제됨)
    wsop_players ||--o{ profile_images : "wsop_player_id"
    gfx_players ||--o{ profile_images : "gfx_player_id"
    wsop_players ||--o{ player_overrides : "wsop_player_id"
    gfx_players ||--o{ player_overrides : "gfx_player_id"

    %% Player Linking - Cross Schema (gfx↔wsop만)
    player_link_mapping }o--|| wsop_players : links
    player_link_mapping }o--|| gfx_players : links

    %% Cuesheet Schema (chip_snapshots 삭제됨)
    broadcast_sessions ||--o{ cue_sheets : has
    cue_sheets ||--o{ cue_items : contains

    %% Orchestration Schema
    job_queue ||--o{ render_queue : triggers
    job_queue ||--o{ notifications : creates
    sync_status ||--o{ sync_history : records

    %% Unified Views - Virtual (gfx + wsop만)
    unified_players }o--|| wsop_players : aggregates
    unified_players }o--|| gfx_players : aggregates

    gfx_sessions {
        uuid id PK
        bigint session_id UK
        text file_hash UK
        table_type table_type
    }

    gfx_hands {
        uuid id PK
        bigint session_id FK
        integer hand_num
    }

    gfx_hand_players {
        uuid id PK
        uuid hand_id FK
        uuid player_id FK
        numeric end_stack_amt
    }

    gfx_events {
        uuid id PK
        uuid hand_id FK
    }

    gfx_players {
        uuid id PK
        text player_hash UK
        text name
    }

    wsop_events {
        uuid id PK
        text event_id UK
        text event_name
    }

    wsop_players {
        uuid id PK
        text wsop_player_id UK
        text name
        text profile_image_url
    }

    wsop_event_players {
        uuid id PK
        uuid event_id FK
        uuid player_id FK
    }

    wsop_chip_counts {
        uuid id PK
        uuid event_id FK
        uuid player_id FK
        bigint chip_count
    }

    profile_images {
        uuid id PK
        uuid wsop_player_id FK "nullable"
        uuid gfx_player_id FK "nullable"
        text file_path
        text url
    }

    player_overrides {
        uuid id PK
        uuid wsop_player_id FK "nullable"
        uuid gfx_player_id FK "nullable"
        text field_name
        text override_value
    }

    player_link_mapping {
        uuid id PK
        uuid wsop_player_id FK
        uuid gfx_player_id FK
        numeric match_confidence
        boolean is_verified
    }

    broadcast_sessions {
        uuid id PK
        text session_code UK
    }

    cue_sheets {
        uuid id PK
        uuid session_id FK
    }

    cue_items {
        uuid id PK
        uuid sheet_id FK
    }

    job_queue {
        uuid id PK
        orch_job_type job_type
    }

    render_queue {
        uuid id PK
        uuid job_id FK
    }

    notifications {
        uuid id PK
        uuid job_id FK
    }

    sync_status {
        uuid id PK
        orch_data_source source
    }

    sync_history {
        uuid id PK
        uuid sync_status_id FK
    }

    unified_players {
        text source "gfx or wsop"
        uuid source_id
        text name
    }

    %% 삭제된 테이블 (참고용)
    %% manual_players - 삭제됨
    %% manual_audit_log - 삭제됨
    %% chip_snapshots - 삭제됨

